<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Verify you're not a robot</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Great+Vibes&family=Playfair+Display:ital,wght@0,400;0,700;1,400&display=swap');

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', sans-serif;
      background: #f0f0f0;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 1.5s ease;
      overflow: hidden;
    }

    /* ========== CAPTCHA SCREEN ========== */
    .captcha-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 100;
      transition: opacity 0.8s ease;
    }

    .captcha-overlay.hidden {
      opacity: 0;
      pointer-events: none;
    }

    .captcha-container {
      background: #fff;
      border-radius: 3px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      width: 400px;
      max-width: 95vw;
      overflow: hidden;
      transform: scale(1);
      transition: transform 0.5s ease, opacity 0.5s ease;
    }

    .captcha-overlay.hidden .captcha-container {
      transform: scale(0.9);
      opacity: 0;
    }

    .captcha-header {
      background: #4a90d9;
      color: white;
      padding: 16px 20px;
      font-size: 15px;
      font-weight: 500;
      line-height: 1.4;
    }

    .captcha-header .instruction {
      font-size: 24px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .captcha-header .sub-instruction {
      font-size: 13px;
      font-weight: 400;
      opacity: 0.9;
    }

    .captcha-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 3px;
      padding: 3px;
      background: #fff;
    }

    .captcha-cell {
      position: relative;
      aspect-ratio: 1;
      overflow: hidden;
      cursor: pointer;
      transition: transform 0.15s ease;
    }

    .captcha-cell:hover {
      filter: brightness(1.05);
    }

    .captcha-cell img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
      transition: transform 0.3s ease;
    }

    .captcha-cell.selected img {
      transform: scale(0.82);
      border-radius: 8px;
    }

    .captcha-cell .check-overlay {
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      display: flex;
      align-items: flex-end;
      justify-content: flex-end;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.2s ease;
    }

    .captcha-cell.selected .check-overlay {
      opacity: 1;
    }

    .captcha-cell .check-circle {
      width: 32px;
      height: 32px;
      background: #4a90d9;
      border-radius: 50%;
      margin: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 1px 3px rgba(0,0,0,0.3);
    }

    .captcha-cell .check-circle svg {
      width: 18px;
      height: 18px;
      fill: none;
      stroke: white;
      stroke-width: 3;
      stroke-linecap: round;
      stroke-linejoin: round;
    }

    .captcha-footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 16px;
      border-top: 1px solid #e0e0e0;
    }

    .captcha-footer-left {
      display: flex;
      gap: 8px;
    }

    .captcha-footer-left button {
      background: none;
      border: none;
      cursor: pointer;
      padding: 4px;
      opacity: 0.5;
      font-size: 18px;
    }

    .verify-btn {
      background: #4a90d9;
      color: white;
      border: none;
      padding: 10px 28px;
      border-radius: 3px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      transition: background 0.2s ease, transform 0.1s ease;
    }

    .verify-btn:hover {
      background: #3a7bc8;
    }

    .verify-btn:active {
      transform: scale(0.97);
    }

    .error-msg {
      color: #d93025;
      font-size: 13px;
      padding: 8px 16px 0;
      display: none;
      font-weight: 500;
    }

    .error-msg.show {
      display: block;
    }

    /* ========== PRE-CAPTCHA CHECKBOX ========== */
    .checkbox-screen {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: #f9f9f9;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 200;
      transition: opacity 0.6s ease;
    }

    .checkbox-screen.hidden {
      opacity: 0;
      pointer-events: none;
    }

    .checkbox-widget {
      background: #fff;
      border: 1px solid #d3d3d3;
      border-radius: 3px;
      font-family: 'Inter', sans-serif;
      outline: none;
      padding: 20px 40px 20px 20px;
      display: flex;
      align-items: center;
      gap: 16px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.08);
      cursor: pointer;
      transition: box-shadow 0.2s ease;
      user-select: none;
    }

    .checkbox-widget:hover {
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }

    .checkbox-box {
      width: 28px;
      height: 28px;
      border: 2px solid #c1c1c1;
      border-radius: 3px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      flex-shrink: 0;
    }

    .checkbox-box.loading {
      border: 3px solid #4a90d9;
      border-top-color: transparent;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .checkbox-label {
      font-size: 14px;
      color: #333;
    }

    .recaptcha-branding {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-left: 40px;
      gap: 2px;
    }

    .recaptcha-logo {
      width: 40px;
      height: 40px;
    }

    .recaptcha-branding span {
      font-size: 10px;
      color: #999;
    }

    .recaptcha-branding small {
      font-size: 8px;
      color: #bbb;
    }

    /* ========== BE MY VALENTINE SCREEN ========== */
    .be-my-valentine-screen {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: linear-gradient(135deg, #1a0a0a 0%, #2d0a0a 30%, #1a0a0a 60%, #0d0507 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      z-index: 75;
      opacity: 0;
      pointer-events: none;
      transition: opacity 1s ease;
    }

    .be-my-valentine-screen.active {
      opacity: 1;
      pointer-events: all;
    }

    .bmv-content {
      text-align: center;
      z-index: 10;
      padding: 20px;
    }

    .bmv-question {
      font-family: 'Playfair Display', serif;
      font-size: clamp(32px, 8vw, 70px);
      color: #e8a0a0;
      text-shadow: 0 0 40px rgba(200, 80, 80, 0.3), 0 0 80px rgba(200, 80, 80, 0.1);
      line-height: 1.3;
      margin-bottom: 50px;
    }

    .bmv-buttons {
      display: flex;
      gap: 30px;
      justify-content: center;
      align-items: center;
      flex-wrap: wrap;
    }

    .bmv-btn {
      font-family: 'Playfair Display', serif;
      font-size: clamp(18px, 4vw, 28px);
      padding: 14px 50px;
      border: 2px solid;
      border-radius: 8px;
      cursor: pointer;
      letter-spacing: 1px;
      transition: all 0.3s ease;
      background: none;
    }

    .bmv-btn-yes {
      color: #e8a0a0;
      border-color: rgba(232, 160, 160, 0.5);
    }

    .bmv-btn-yes:hover {
      background: rgba(232, 160, 160, 0.15);
      border-color: #e8a0a0;
      transform: scale(1.05);
    }

    .bmv-btn-no {
      color: #886060;
      border-color: rgba(136, 96, 96, 0.3);
      font-size: clamp(14px, 2.5vw, 20px);
      padding: 10px 30px;
      position: relative;
      transition: transform 0.18s ease, border-color 0.2s ease;
      will-change: transform;
    }

    .bmv-btn-no:hover {
      border-color: rgba(136, 96, 96, 0.5);
    }

    .wrong-answer-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0, 0, 0, 0.85);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      z-index: 80;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }

    .wrong-answer-overlay.active {
      opacity: 1;
      pointer-events: all;
    }

    .wrong-answer-text {
      font-family: 'Playfair Display', serif;
      font-size: clamp(40px, 10vw, 90px);
      color: #e8a0a0;
      text-align: center;
      opacity: 0;
      line-height: 1.3;
      text-shadow: 0 0 40px rgba(200, 80, 80, 0.3);
    }

    .wrong-answer-text .line1 {
      display: block;
      margin-bottom: 15px;
    }

    .wrong-answer-text .line2 {
      display: block;
    }

    @keyframes wrongFlash {
      0% { opacity: 0; transform: scale(0.5); }
      8% { opacity: 1; transform: scale(0.5); }
      20% { opacity: 1; transform: scale(1.0); }
      35% { opacity: 1; transform: scale(1.0); }
      42% { opacity: 1; transform: scale(0.5); }
      55% { opacity: 1; transform: scale(0.5); }
      67% { opacity: 1; transform: scale(1.0); }
      80% { opacity: 1; transform: scale(1.0); }
      90% { opacity: 0.5; transform: scale(1.0); }
      100% { opacity: 0; transform: scale(1.0); }
    }

    .wrong-answer-text.flash {
      animation: wrongFlash 5s ease forwards;
    }

    /* ========== VALENTINE SCREEN ========== */
    .valentine-screen {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: linear-gradient(135deg, #1a0a0a 0%, #2d0a0a 30%, #1a0a0a 60%, #0d0507 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      z-index: 50;
      opacity: 0;
      pointer-events: none;
      transition: opacity 1.5s ease;
      overflow: hidden;
    }

    .valentine-screen.active {
      opacity: 1;
      pointer-events: all;
    }

    .hearts-container {
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      overflow: hidden;
      pointer-events: none;
    }

    .floating-heart {
      position: absolute;
      bottom: -80px;
      opacity: 0;
      animation: floatUp var(--duration) ease-in forwards;
      animation-delay: var(--delay);
      font-size: var(--size);
      color: var(--color);
      filter: blur(var(--blur, 0px));
    }

    @keyframes floatUp {
      0% {
        opacity: 0;
        transform: translateY(0) translateX(0) rotate(0deg) scale(0.5);
      }
      10% {
        opacity: var(--max-opacity, 0.8);
        transform: translateY(-10vh) translateX(var(--sway)) rotate(15deg) scale(1);
      }
      50% {
        opacity: var(--max-opacity, 0.6);
        transform: translateY(-50vh) translateX(calc(var(--sway) * -1)) rotate(-10deg) scale(0.95);
      }
      90% {
        opacity: 0.2;
      }
      100% {
        opacity: 0;
        transform: translateY(-110vh) translateX(var(--sway)) rotate(20deg) scale(0.7);
      }
    }

    .valentine-content {
      text-align: center;
      z-index: 10;
      padding: 20px;
    }

    .valentine-title {
      font-family: 'Playfair Display', serif;
      font-size: clamp(40px, 10vw, 90px);
      color: #e8a0a0;
      opacity: 0;
      transform: translateY(30px) scale(0.9);
      animation: fadeInUp 2s ease forwards;
      animation-delay: 0.5s;
      text-shadow: 0 0 40px rgba(200, 80, 80, 0.3), 0 0 80px rgba(200, 80, 80, 0.1);
      line-height: 1.2;
    }

    .valentine-subtitle {
      font-family: 'Playfair Display', serif;
      font-size: clamp(18px, 4vw, 32px);
      color: #c47070;
      opacity: 0;
      transform: translateY(20px);
      animation: fadeInUp 2s ease forwards;
      animation-delay: 2s;
      margin-top: 20px;
      font-style: italic;
      font-weight: 400;
      letter-spacing: 2px;
    }

    .valentine-heart-icon {
      opacity: 0;
      animation: heartPulseIn 2s ease forwards;
      animation-delay: 3.2s;
      margin-top: 30px;
      font-size: clamp(40px, 8vw, 70px);
      filter: drop-shadow(0 0 20px rgba(200, 50, 50, 0.4));
    }

    .valentine-extra {
      font-family: 'Playfair Display', serif;
      font-size: clamp(14px, 3vw, 22px);
      color: #a05555;
      opacity: 0;
      transform: translateY(15px);
      animation: fadeInUp 2s ease forwards;
      animation-delay: 4.5s;
      margin-top: 25px;
      letter-spacing: 3px;
      font-weight: 400;
    }

    .one-more-thing {
      font-family: 'Playfair Display', serif;
      font-size: clamp(14px, 2.5vw, 20px);
      color: #c47070;
      opacity: 0;
      transform: translateY(15px);
      animation: fadeInUp 2s ease forwards;
      animation-delay: 6.5s;
      margin-top: 40px;
      background: none;
      border: none;
      border-bottom: 1px solid rgba(196, 112, 112, 0.4);
      cursor: pointer;
      padding: 4px 2px;
      font-style: italic;
      letter-spacing: 1px;
      transition: color 0.3s ease, border-color 0.3s ease;
    }

    .one-more-thing:hover {
      color: #e8a0a0;
      border-bottom-color: rgba(232, 160, 160, 0.6);
    }

    .one-more-thing.hidden {
      display: none;
    }

    .ps-message {
      font-family: 'Playfair Display', serif;
      font-size: clamp(14px, 2.8vw, 22px);
      color: #c47070;
      opacity: 0;
      transform: translateY(20px);
      margin-top: 35px;
      font-style: italic;
      font-weight: 400;
      letter-spacing: 1px;
      line-height: 1.6;
      max-width: 500px;
      pointer-events: none;
      transition: opacity 2s ease, transform 2s ease;
    }

    .ps-message.visible {
      opacity: 1;
      transform: translateY(0);
    }

    @keyframes fadeInUp {
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    @keyframes heartPulseIn {
      0% {
        opacity: 0;
        transform: scale(0);
      }
      50% {
        opacity: 1;
        transform: scale(1.3);
      }
      70% {
        transform: scale(0.9);
      }
      85% {
        transform: scale(1.1);
      }
      100% {
        opacity: 1;
        transform: scale(1);
        animation: none;
      }
    }

    .valentine-heart-icon.pulse {
      animation: heartBeat 1.5s ease-in-out infinite;
    }

    @keyframes heartBeat {
      0%, 100% { transform: scale(1); }
      15% { transform: scale(1.15); }
      30% { transform: scale(1); }
      45% { transform: scale(1.1); }
    }

    /* Sparkle particles */
    .sparkle {
      position: absolute;
      width: 4px;
      height: 4px;
      background: radial-gradient(circle, #fff 0%, transparent 70%);
      border-radius: 50%;
      pointer-events: none;
      animation: sparkle var(--spark-duration, 3s) ease-in-out infinite;
      animation-delay: var(--spark-delay, 0s);
      opacity: 0;
    }

    @keyframes sparkle {
      0%, 100% { opacity: 0; transform: scale(0); }
      50% { opacity: var(--spark-opacity, 0.8); transform: scale(1); }
    }

    /* Subtle rose petal vignette */
    .valentine-screen::before {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      background: radial-gradient(ellipse at center, transparent 40%, rgba(10, 0, 0, 0.6) 100%);
      pointer-events: none;
      z-index: 1;
    }

    /* Soft glow behind text */
    .valentine-content::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 500px;
      height: 500px;
      background: radial-gradient(circle, rgba(180, 60, 60, 0.15) 0%, transparent 70%);
      border-radius: 50%;
      pointer-events: none;
      z-index: -1;
    }

    /* Green checkmark animation for captcha success */
    .captcha-success-overlay {
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(255,255,255,0.95);
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.4s ease;
      z-index: 10;
    }

    .captcha-success-overlay.show {
      opacity: 1;
    }

    .success-checkmark {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: #4caf50;
      display: flex;
      align-items: center;
      justify-content: center;
      transform: scale(0);
      transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    .captcha-success-overlay.show .success-checkmark {
      transform: scale(1);
    }

    .success-checkmark svg {
      width: 40px;
      height: 40px;
      fill: none;
      stroke: white;
      stroke-width: 3;
      stroke-linecap: round;
      stroke-linejoin: round;
      stroke-dasharray: 50;
      stroke-dashoffset: 50;
      transition: stroke-dashoffset 0.5s ease 0.3s;
    }

    .captcha-success-overlay.show .success-checkmark svg {
      stroke-dashoffset: 0;
    }
  </style>
</head>
<body>

  <!-- STEP 1: "I'm not a robot" checkbox -->
  <div class="checkbox-screen" id="checkboxScreen">
    <button class="checkbox-widget" id="checkboxWidget" onclick="handleCheckboxClick()" type="button">
      <div class="checkbox-box" id="checkboxBox"></div>
      <span class="checkbox-label">I'm not a robot</span>
      <div class="recaptcha-branding">
        <svg class="recaptcha-logo" viewBox="0 0 64 64">
          <g transform="translate(8,8)">
            <path d="M24 4L24 0L20 4L24 8L24 4C33 4 40 11 40 20L44 20C44 9 35 0 24 0L24 4Z" fill="#1c3aa9"/>
            <path d="M44 20L48 20L44 16L40 20L44 20C44 29 37 36 28 36L28 40C37 40 44 33 48 24L44 20Z" fill="#4285f4" opacity="0.6"/>
            <path d="M24 36L24 40L28 36L24 32L24 36C15 36 8 29 8 20L4 20C4 31 13 40 24 40L24 36Z" fill="#ababab"/>
          </g>
        </svg>
        <span>reCAPTCHA</span>
        <small>Privacy - Terms</small>
      </div>
    </button>
  </div>

  <!-- STEP 2: CAPTCHA image grid -->
  <div class="captcha-overlay hidden" id="captchaOverlay">
    <div class="captcha-container" style="position: relative;">
      <div class="captcha-header">
        <div class="instruction">Select all squares with<br><strong>your Valentine</strong></div>
        <div class="sub-instruction">If there are none, click skip</div>
      </div>
      <div class="captcha-grid" id="captchaGrid">
        <!-- 9 cells will be generated by JS -->
      </div>
      <div class="error-msg" id="errorMsg">Please select all matching images.</div>
      <div class="captcha-footer">
        <div class="captcha-footer-left">
          <button title="Reload">&#x21bb;</button>
          <button title="Audio">&#x1f50a;</button>
          <button title="Info">&#x2139;</button>
        </div>
        <button class="verify-btn" id="verifyBtn" onclick="handleVerify()">Verify</button>
      </div>
      <div class="captcha-success-overlay" id="successOverlay">
        <div class="success-checkmark">
          <svg viewBox="0 0 24 24"><polyline points="4 12 10 18 20 6"/></svg>
        </div>
      </div>
    </div>
  </div>

  <!-- STEP 3: Be My Valentine? -->
  <div class="be-my-valentine-screen" id="beMyValentineScreen">
    <div class="bmv-content">
      <div class="bmv-question">Will you be my<br>Valentine?</div>
      <div class="bmv-buttons">
        <button class="bmv-btn bmv-btn-yes" onclick="handleYes()">Yes</button>
        <button class="bmv-btn bmv-btn-no" id="noBtn">No</button>
      </div>
    </div>
  </div>

  <!-- Wrong answer overlay -->
  <div class="wrong-answer-overlay" id="wrongAnswerOverlay">
    <div class="wrong-answer-text" id="wrongAnswerText">
      <span class="line1">that is the wrong answer...</span>
      <span class="line2">try again</span>
    </div>
  </div>

  <!-- STEP 4: Valentine's screen -->
  <div class="valentine-screen" id="valentineScreen">
    <div class="hearts-container" id="heartsContainer"></div>
    <div class="valentine-content">
      <div class="valentine-title">Happy Valentine's Ella</div>
      <div class="valentine-heart-icon" id="mainHeart">&#10084;&#65039;</div>
      <div class="valentine-extra">I love you x</div>
      <button class="one-more-thing" id="oneMoreThing" onclick="showPS()">one more thing...</button>
      <div class="ps-message" id="psMessage">There is a surprise waiting for you for when you get home x</div>
    </div>
  </div>

  <script>
    // ========== Photo filenames ==========
    const photos = [
      'images/0728A1F5-CBE8-4B6D-947D-0567751119EF.JPG',
      'images/8ADBD11D-88A6-4F20-AACF-55246CB66E1D 2.JPG',
      'images/IMG_0938.jpg',
      'images/IMG_0939.jpg',
      'images/IMG_4523.JPG',
      'images/IMG_7016 2.JPG',
      'images/1ebfbd01-2693-43e0-a85b-828cdcc76ed5.JPG',
      'images/IMG_0001.jpg',
      'images/IMG_4446.JPG',
    ];

    // Shuffle array
    function shuffle(arr) {
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    // ========== Build CAPTCHA grid ==========
    const grid = document.getElementById('captchaGrid');
    const shuffled = shuffle([...photos]);
    const selected = new Set();

    shuffled.forEach((src, i) => {
      const cell = document.createElement('div');
      cell.className = 'captcha-cell';
      cell.setAttribute('role', 'button');
      cell.setAttribute('tabindex', '0');
      cell.setAttribute('aria-label', 'captcha image ' + (i + 1));
      cell.innerHTML = `
        <img src="${encodeURI(src)}" alt="captcha image ${i + 1}" draggable="false">
        <div class="check-overlay">
          <div class="check-circle">
            <svg viewBox="0 0 24 24"><polyline points="4 12 10 18 20 6"/></svg>
          </div>
        </div>
      `;
      cell.addEventListener('click', () => {
        cell.classList.toggle('selected');
        if (selected.has(i)) {
          selected.delete(i);
        } else {
          selected.add(i);
        }
        // Hide error when user selects
        document.getElementById('errorMsg').classList.remove('show');
      });
      grid.appendChild(cell);
    });

    // ========== Checkbox click ==========
    function handleCheckboxClick() {
      const box = document.getElementById('checkboxBox');
      box.classList.add('loading');
      // Fake loading then show captcha
      setTimeout(() => {
        document.getElementById('checkboxScreen').classList.add('hidden');
        document.getElementById('captchaOverlay').classList.remove('hidden');
      }, 1500);
    }

    // ========== Verify ==========
    function handleVerify() {
      if (selected.size === 9) {
        // Success!
        const overlay = document.getElementById('successOverlay');
        overlay.classList.add('show');

        setTimeout(() => {
          document.getElementById('captchaOverlay').classList.add('hidden');
          showBeMyValentine();
        }, 1800);
      } else {
        document.getElementById('errorMsg').classList.add('show');

        // Shake effect
        const container = document.querySelector('.captcha-container');
        container.style.animation = 'none';
        container.offsetHeight; // trigger reflow
        container.style.animation = 'shake 0.5s ease';
      }
    }

    // ========== Be My Valentine ==========
    let noOffsetX = 0;
    let noOffsetY = 0;
    let dodgeSetupDone = false;

    function resetNoButtonPosition() {
      const noBtn = document.getElementById('noBtn');
      noOffsetX = 0;
      noOffsetY = 0;
      noBtn.style.transform = 'translate(0px, 0px)';
    }

    function moveNoButtonAway() {
      const noBtn = document.getElementById('noBtn');
      const container = document.querySelector('.bmv-content');
      const btnRect = noBtn.getBoundingClientRect();
      const containerRect = container.getBoundingClientRect();

      // Keep movement inside the valentine prompt area.
      const maxX = Math.max(35, (containerRect.width / 2) - btnRect.width - 10);
      const maxY = Math.max(30, (containerRect.height / 2) - btnRect.height - 10);

      let nextX = (Math.random() * 2 - 1) * maxX;
      let nextY = (Math.random() * 2 - 1) * maxY;

      // Avoid tiny moves so it always feels like it escaped.
      if (Math.abs(nextX - noOffsetX) < 40) nextX += nextX > 0 ? 45 : -45;
      if (Math.abs(nextY - noOffsetY) < 25) nextY += nextY > 0 ? 30 : -30;

      noOffsetX = Math.max(-maxX, Math.min(maxX, nextX));
      noOffsetY = Math.max(-maxY, Math.min(maxY, nextY));
      noBtn.style.transform = `translate(${noOffsetX}px, ${noOffsetY}px)`;
    }

    function setupNoButtonDodge() {
      if (dodgeSetupDone) return;
      dodgeSetupDone = true;

      const noBtn = document.getElementById('noBtn');

      // On desktop: as soon as pointer gets near, move away.
      noBtn.addEventListener('mouseenter', moveNoButtonAway);
      noBtn.addEventListener('mousemove', moveNoButtonAway);

      // On touch: move away before tap can land.
      noBtn.addEventListener('touchstart', (event) => {
        event.preventDefault();
        moveNoButtonAway();
      }, { passive: false });

      // Block actual click on "No".
      noBtn.addEventListener('click', (event) => {
        event.preventDefault();
        moveNoButtonAway();
      });
    }

    function showBeMyValentine() {
      const screen = document.getElementById('beMyValentineScreen');
      setupNoButtonDodge();
      resetNoButtonPosition();
      screen.classList.add('active');
      document.body.style.background = '#1a0a0a';
    }

    function handleYes() {
      document.getElementById('beMyValentineScreen').classList.remove('active');
      showValentine();
    }

    let noClickCount = 0;
    function handleNo() {
      noClickCount++;
      const overlay = document.getElementById('wrongAnswerOverlay');
      const text = document.getElementById('wrongAnswerText');

      // Show overlay
      overlay.classList.add('active');

      // Reset animation
      text.classList.remove('flash');
      void text.offsetHeight; // trigger reflow
      text.classList.add('flash');

      // After animation ends, hide overlay and go back to choice
      setTimeout(() => {
        overlay.classList.remove('active');
        text.classList.remove('flash');

        // Make the No button smaller each time she clicks it
        const noBtn = document.getElementById('noBtn');
        const currentSize = parseFloat(getComputedStyle(noBtn).fontSize);
        noBtn.style.fontSize = Math.max(currentSize * 0.7, 8) + 'px';
        noBtn.style.padding = Math.max(10 - noClickCount * 2, 2) + 'px ' + Math.max(30 - noClickCount * 5, 8) + 'px';
      }, 5500);
    }

    // ========== Show Valentine ==========
    function showValentine() {
      const screen = document.getElementById('valentineScreen');
      screen.classList.add('active');
      document.body.style.background = '#1a0a0a';

      // Start floating hearts
      createFloatingHearts();
      createSparkles();

      // Start heartbeat after initial animation
      setTimeout(() => {
        document.getElementById('mainHeart').classList.add('pulse');
      }, 5500);
    }

    // ========== Floating Hearts ==========
    function createFloatingHearts() {
      const container = document.getElementById('heartsContainer');
      const heartSymbols = ['&#10084;&#65039;', '&#x1F495;', '&#x1F496;', '&#x1F497;', '&#x1F49C;', '&#x1F49B;', '&#10084;&#65039;', '&#x2764;', '&#x1F90D;', '&#x1F90E;'];
      const colors = ['#e74c6f', '#ff6b8a', '#c0392b', '#e84393', '#ff7979', '#d63031', '#fd79a8', '#b83280', '#e8a0a0', '#cc5577'];

      function spawnHeart() {
        const heart = document.createElement('div');
        heart.className = 'floating-heart';
        heart.innerHTML = heartSymbols[Math.floor(Math.random() * heartSymbols.length)];

        const x = Math.random() * 100;
        const size = 16 + Math.random() * 36;
        const duration = 6 + Math.random() * 10;
        const delay = Math.random() * 0.5;
        const sway = (Math.random() - 0.5) * 80;
        const blur = Math.random() > 0.7 ? (1 + Math.random() * 2) : 0;
        const maxOpacity = 0.3 + Math.random() * 0.5;

        heart.style.left = x + '%';
        heart.style.setProperty('--size', size + 'px');
        heart.style.setProperty('--duration', duration + 's');
        heart.style.setProperty('--delay', delay + 's');
        heart.style.setProperty('--sway', sway + 'px');
        heart.style.setProperty('--color', colors[Math.floor(Math.random() * colors.length)]);
        heart.style.setProperty('--blur', blur + 'px');
        heart.style.setProperty('--max-opacity', maxOpacity);

        container.appendChild(heart);

        // Remove after animation
        setTimeout(() => {
          heart.remove();
        }, (duration + delay + 1) * 1000);
      }

      // Initial burst
      for (let i = 0; i < 25; i++) {
        setTimeout(spawnHeart, i * 200);
      }

      // Continuous spawning
      setInterval(spawnHeart, 600);
    }

    // ========== Sparkles ==========
    function createSparkles() {
      const screen = document.getElementById('valentineScreen');
      for (let i = 0; i < 40; i++) {
        const sparkle = document.createElement('div');
        sparkle.className = 'sparkle';
        sparkle.style.left = Math.random() * 100 + '%';
        sparkle.style.top = Math.random() * 100 + '%';
        sparkle.style.setProperty('--spark-duration', (2 + Math.random() * 4) + 's');
        sparkle.style.setProperty('--spark-delay', (Math.random() * 5) + 's');
        sparkle.style.setProperty('--spark-opacity', (0.3 + Math.random() * 0.7).toString());
        sparkle.style.width = (2 + Math.random() * 4) + 'px';
        sparkle.style.height = sparkle.style.width;
        screen.appendChild(sparkle);
      }
    }

    // ========== One More Thing ==========
    function showPS() {
      const btn = document.getElementById('oneMoreThing');
      const msg = document.getElementById('psMessage');
      btn.classList.add('hidden');
      msg.classList.add('visible');
    }

    // ========== Shake animation ==========
    const style = document.createElement('style');
    style.textContent = `
      @keyframes shake {
        0%, 100% { transform: translateX(0); }
        20% { transform: translateX(-10px); }
        40% { transform: translateX(10px); }
        60% { transform: translateX(-6px); }
        80% { transform: translateX(6px); }
      }
    `;
    document.head.appendChild(style);
  </script>

</body>
</html>
